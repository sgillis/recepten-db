{% extends "base.html" %}

{% block scripts %}
<script type="text/javascript">
function updateElementIndex(el, prefix, index) {
  var regex = new RegExp('(' + prefix + '-?_?)\\d+');
  var replacement = '$1' + index;
  if (el.id) el.id = el.id.replace(regex, replacement);
  if (el.name) el.name = el.name.replace(regex, replacement);
}

function addForm(btn, prefix){
  var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
  var row = $('.dynamic-form:last').clone();
  // Copy the last dynamic-form element, and paste it under the last element.
  $(row).insertAfter($('.dynamic-form:last'))
  // Edit the id's of every tag in the cloned element
  $(row).find('*').each(function(){
    updateElementIndex(this, prefix, formCount);
  });
  // The copied Chosen element will not work. To make it work we remove the
  // div that was generated by chosen, we remove the chzn-done class, and we
  // remove the hidden style option from select. Then we rerun chosen on 
  // the select element.
  // TODO: Should find a way to get the option for chosen() from the copied
  // chosen element.
  $(row).find('div.chzn-container').remove();
  $(row).find('select').show();
  $(row).find('select').removeClass('chzn-done');
  $(row).find('select').chosen({allow_single_deselect: true});
  // Update the total number of forms
  $('#id_' + prefix + '-TOTAL_FORMS').val(formCount + 1);
  // Make the remove row button visible and active
  $(row).find('a.remove-row').css('display','').on('click', function(event){removeForm(this,'form')});
  return false;
};

function removeForm(button, prefix){
  console.log('test');
  $(button).parents('.dynamic-form').remove();
  var forms = $('.dynamic-form');
  $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
  for (var i=0, formCount=forms.length; i<formCount; i++){
    $(forms.get(i)).find('*').each(function(){
      updateElementIndex(this, prefix, i);
    });
  }
  return false
};

$(function(){
  $('.add-row').click(function() {
    addForm(this, 'form');
  });
  $('.remove-row').click(function() {
    console.log('test');
    removeForm(this, 'form');
  });
});
</script>
{% endblock %}

{% block content %}
<div class="panel left">
<h1>Recept toevoegen</h1>
<form enctype="multipart/form-data" method="POST" action="/submit_recipe/">{% csrf_token %}
  {% for field in recept_form %}
    <div class="fieldwrapper">
    {{ field.label }}
    {{ field.errors }}
    <p>
    {{ field }}
    {% if field.label == "Bereidingstijd" %}min.{% endif %}
    </p>
    </div>
    {% if field.label == "Recept naam" %}
      <div class="fieldwrapper">
      <div class="dynamic-form">
      {% for form in hoeveelheid_formset %}
        <p>
          {% for field in form %}
            {{ field }}
          {% endfor %}
          <a href="javascript:void(0)" class="remove-row" style="display:none;">Verwijder ingredient</a>
        </p>
      {% endfor %}
      <!-- <input type="submit" name="add" value="Add"> -->
      </div>
      <a href="javascript:void(0)" class="add-row">Voeg ingredient toe</a>
      </div>
    {% endif %}
  {% endfor %}
  {{ hoeveelheid_formset.management_form }}
  <div class="submitbutton">
  <input type="submit" name="submit_recipe" value="Toevoegen" style="float: right">
  </div>
</form>
</div>

<div class="panel right">
<h1>Ingredient toevoegen</h1>
<form method="POST" action='/ingredient_toevoegen/'>{% csrf_token %}
  {% for field in ingredient_form %}
    <div class="fieldwrapper">
    {{ field.label }}
    <p>{{ field }}</p>
    </div>
  {% endfor %}
  <input type="submit" name="ingredient_toevoegen" value="Toevoegen" style="float: right">
</form>
</div>

<!-- CHOSEN -->
<script src="{{ STATIC_URL }}chosen.jquery.js" type="text/javascript"></script>
<script type="text/javascript"> 
        $(document).ready(function(){
                $('.chzn-select').chosen();
                $('.chzn-select-removable').chosen({allow_single_deselect: true});
        });
</script>

{% endblock %}
